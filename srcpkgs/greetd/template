# Template file for 'greetd'
pkgname=greetd
version=0.8.0
revision=1
wrksrc=${pkgname}-${version}
build_style=cargo
makedepends="pam-devel scdoc"
depends="pam"
conf_files="/etc/greetd/config.toml
/etc/pam.d/greetd"
make_dirs="/etc/greetd 0644 root root"
system_accounts="_greeter"
_greeter_descr="greetd system greeter user"
_greeter_groups="video"
_greeter_homedir="/etc/greetd"
short_desc="A minimal and flexible login manager daemon"
maintainer="lane-brain <lane@mailbox.org>"
license="GPL-3.0-or-later"
changelog="https://git.sr.ht/~kennylevinsen/greetd/log"
homepage="https://git.sr.ht/~kennylevinsen/greetd"
distfiles="${homepage}/archive/${version}.tar.gz"
checksum=47a73709df60f04b63fc50cfc409e47a451a9620777638f527b9d9333256035f
patch_args="-Np1"

post_build() {
    #cd man
    for i in man/*.scd; do
        scdoc < "$i" > "$(basename "$i" .scd)".roff
    done
}

do_install() {
    vbin target/"${XBPS_RUST_TARGET}"/release/agreety
    vbin target/"${XBPS_RUST_TARGET}"/release/fakegreet
    vbin target/"${XBPS_RUST_TARGET}"/release/greetd

    # Install man pages
    for n in 1 5 7; do
        vmkdir usr/share/man/man$n
        for i in *-$n.roff; do
            vinstall $i 755 usr/share/man/man$n ${i%-*}.$n
        done
    done

    vinstall "${FILESDIR}"/greetd.pam 644 etc/pam.d greetd
    vinstall config.toml 644 etc/greetd
    vsv greetd
}
